name: Helm Chart CI Check
# TODO: Add helm test and update the CI to run tests
on:
  pull_request:
    branches:
      - main
    paths:
      - 'charts/**'
      - '.github/workflows/helm-check.yaml'

jobs:
  template-validation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.13.0'

      - name: add repo 
        run: |
          helm repo add argo https://argoproj.github.io/argo-helm
          helm repo add nats https://nats-io.github.io/k8s/helm/charts
          helm repo add cloudnative-pg https://cloudnative-pg.github.io/charts
          helm repo add opensearch https://opensearch-project.github.io/opensearch-k8s-operator
          helm repo add nvidia https://helm.ngc.nvidia.com/nvidia
          helm repo add enapter https://enapter.github.io/charts
          helm repo add openfga https://openfga.github.io/helm-charts

      - name: validate helm template for platform-core 
        run: |
          set -e
          helm dependency update
          helm template test ./charts/platform-core

      - name: validate helm template for platform 
        run: |
          set -e
          helm dependency update
          helm template test ./charts/platform

      - name: validate helm template for enkryptai-stack 
        run: |
          set -e
          helm dependency update
          helm template test ./charts/enkryptai-stack 
      

  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@master
        with:
          directory: charts/
          framework: helm
          soft_fail: true

  documentation-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for README
        run: |
          for chart in charts/*/; do
            if [ ! -f "${chart}README.md" ]; then
              echo "::error::Missing README.md in $chart"
              exit 1
            fi
          done

      - name: Generate docs with helm-docs
        run: |
          curl -sSL https://github.com/norwoodj/helm-docs/releases/download/v1.11.0/helm-docs_1.11.0_Linux_x86_64.tar.gz | tar xz
          ./helm-docs --dry-run

  summary:
    needs: [template-validation, security-scan, documentation-check]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check results
        run: |
          if [[ "${{ needs.lint-and-test.result }}" != "success" ]] || \
             [[ "${{ needs.template-validation.result }}" != "success" ]] || \
             [[ "${{ needs.version-check.result }}" != "success" ]] || \
             [[ "${{ needs.documentation-check.result }}" != "success" ]]; then
            echo "One or more required checks failed"
            exit 1
          fi
          echo "All checks passed successfully!"
