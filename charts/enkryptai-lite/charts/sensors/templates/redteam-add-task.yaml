apiVersion: argoproj.io/v1alpha1
kind: Sensor
metadata:
  name: redteam-add-task-sensor
  namespace: argo-events
  annotations:
    "helm.sh/hook-weight": "10"
    "helm.sh/hook": post-install, post-upgrade
spec:
  dependencies:
  - eventName: redteam
    eventSourceName: redteam-add-task
    name: redteam-add-task
  eventBusName: redteam-eventbus
  template:
    serviceAccountName: argo-events-sa
  triggers:
  - template:
      argoWorkflow:
        operation: submit
        parameters:
        - dest: spec.arguments.parameters.0.value
          src:
            dataKey: body
            dependencyName: redteam-add-task
        source:
          resource:
            apiVersion: argoproj.io/v1alpha1
            kind: Workflow
            metadata:
              generateName: redteam-add-task-job-
              namespace: redteam-jobs
            spec:
              tolerations:
              - effect: NoSchedule
                key: app
                operator: Equal
                value: redteaming
              affinity:
                nodeAffinity:
                  requiredDuringSchedulingIgnoredDuringExecution:
                    nodeSelectorTerms:
                    - matchExpressions:
                      - key: dedicated
                        operator: In
                        values:
                        - redteaming
              arguments:
                parameters:
                - name: event-data
                  value: '{{"{{.Input.body}}"}}'
              entrypoint: process-order
              templates:
              - container:
                  command:
                    - python
                    - job/job_service_sync_all.py
                  env:
                  - name: WORKER_TYPE 
                    value: "combined" 
                  - name: NATS_URL
                    value: {{ index .Values "redteam-jobs" "dev" "natsURL" }}
                  - name: IS_PROXY_MODE
                    value: "true"
                  - name: RT_NATS_PAYLOAD
                    value: '{{"{{inputs.parameters.event-data}}"}}'
                  envFrom:
                  - secretRef:
                      name: redteam-proxy-env-secret
                  image: 188451452903.dkr.ecr.us-east-1.amazonaws.com/enkryptai-dev/redteam-job:{{ index .Values "redteam-jobs" "dev" "version" }}
                  imagePullPolicy: Always
                inputs:
                  parameters:
                  - name: event-data
                name: process-order
      name: argo-workflow-trigger
