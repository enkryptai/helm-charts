apiVersion: batch/v1
kind: Job
metadata:
  name: db-check-and-grant
    "helm.sh/hook-weight": "21"
    "helm.sh/hook": post-install
spec:
  backoffLimit: 2
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: db-check
          image: {{ .Values.global.registry }}/{{ .Values.databasekong.repository }}:{{ .Values.databasekong.tag }}
          resources:
            {{- toYaml .Values.databasekong.resources | nindent 12 }}
          env:
            - name: DB_NAME
              value: "postgres"
            - name: DB_HOST
              value: "supabase-cluster-rw"
            - name: DB_PORT
              value: "5432"
            - name: DB_USER
              value: "postgres"

          volumeMounts:
            - name: superuser-secret
              mountPath: /run/dbcreds
              readOnly: true

          command:
            - /bin/bash
            - -c
            - |
              set -e

              DB_PASSWORD=$(cat /run/dbcreds/DB_PASSWORD)
              GRANT_SQL=$(cat /run/dbcreds/kong.sql)

              echo "üîç Checking if database is up..."
              RETRIES=20

              until pg_isready -h "$DB_HOST" -U "$DB_USER" -d "$DB_NAME" || [ $RETRIES -eq 0 ]; do
                echo "‚è≥ Waiting for DB... ($RETRIES retries left)"
                RETRIES=$((RETRIES-1))
                sleep 10
              done

              if [ $RETRIES -eq 0 ]; then
                echo "‚ùå Database is not reachable."
                exit 1
              fi

              echo "‚úÖ Database is up. Applying GRANT SQL..."
              echo "$GRANT_SQL" | PGPASSWORD="$DB_PASSWORD" psql -h "$DB_HOST" -U "$DB_USER" -d "$DB_NAME" -v ON_ERROR_STOP=1

              echo "üéØ Grant applied successfully."

      volumes:
        - name: superuser-secret
          secret:
            secretName: superuser-secret
