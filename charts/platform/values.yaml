global: 
  platform: aws
  registry: 188451452903.dkr.ecr.us-east-1.amazonaws.com
aws: 
  region: "us-west-2"
backup: 
  openfgsS3Bucket: "s3://vpc"
  supabaseS3Bucket: "s3://vpc"
supabase:
    repository: supabase
    tag: 16.0.1
    resources:
      requests:
        cpu: 0.5
        memory: 1Gi
      limits:
        cpu: 1.5
        memory: 2Gi
openfga:
    repository: onprem/postgresql
    tag: 17.4-8
    resources:
      requests:
        cpu: 0.5
        memory: 1Gi
      limits:
        cpu: 1.5
        memory: 2Gi

databasekong:
  repository: onprem/postgres
  tag: 16
  resources:
    limits:
      cpu: "200m"
      memory: "256Mi"
    requests:
      cpu: "100m"
      memory: "128Mi"
migrationjob:
  repository: onprem/postgres
  tag: 15
  resources:
    limits:
      cpu: "200m"
      memory: "256Mi"
    requests:
      cpu: "100m"
      memory: "128Mi"
sensor: 
  natsURL: "nats://nats.enkryptai-stack:4222"
  jobversion: "dev-v1.1.76" 
  jobImage: 188451452903.dkr.ecr.us-east-1.amazonaws.com/enkryptai-dev/redteam-job 
  resources:
    requests:
      cpu: 30m
      memory: 50Mi
    limits:
      cpu: 50m
      memory: 50Mi
adminpassword: 
  secretName: "opensearch-cred"
clustername: "enkryptai-opensearch"

opensearch:
  general:
    image: "188451452903.dkr.ecr.us-east-1.amazonaws.com/onprem/opensearch:3.2.0"
    resources:
      limits:
        cpu: 100m
        memory: 512M
      requests:
        cpu: 100m
        memory: 512M
  dashboards:
    image: "188451452903.dkr.ecr.us-east-1.amazonaws.com/onprem/opensearch-dashboards:3.2.0"
    resources:
      requests:
        cpu: "100m"
        memory: "512M"
      limits:
        cpu: "100m"
        memory: "512M"
    dashboardAnnotations: 
      owner: enkryptai
      cost-center: ""
  ism:
    # enabled: true
      policyName: "otel-logs-lifecycle"
      indexPattern: "otel-logs-*"
      retentionDays: 15d
  initHelper:
    image: "188451452903.dkr.ecr.us-east-1.amazonaws.com/onprem/busybox:latest"
  security:
  securityconfig: false
  users:
    admin:
      hash: ""
    dashboarduser:
      hash: ""
    kong_logs_plugin:
      hash: ""
    kibana_read_only:
      hash: ""

platform-core:

  cloudnative-pg:
    commonAnnotations: 
      owner: enkryptai
      cost-center: ""
    enabled: true
    image:
      repository: 188451452903.dkr.ecr.us-east-1.amazonaws.com/onprem/cloudnative-pg
      tag: "1.27.0"
    resources:
      requests:
        cpu: 50m
        memory: 100Mi
      limits:
        cpu: 200m
        memory: 300Mi

  opensearch-operator:
    manager:
      image:
        repository: 188451452903.dkr.ecr.us-east-1.amazonaws.com/onprem/opensearch-operator
        tag: "2.8.0"
    kubeRbacProxy:
      image:
        repository: 188451452903.dkr.ecr.us-east-1.amazonaws.com/onprem/kube-rbac-proxy
        tag: "v0.15.0"
    openSearchAnnotations:
      owner: enkryptai
      cost-center: ""
  gpu-operator:
    operator:
      repository: 188451452903.dkr.ecr.us-east-1.amazonaws.com
      image: onprem/gpu-operator
      version: v24.9.0
      initContainer:
        repository: 188451452903.dkr.ecr.us-east-1.amazonaws.com
        image: onprem/gpu-operator-init
        version: v24.9.0
      annotations:
        owner: enkryptai
        cost-center: ""
    node-feature-discovery:
      daemonsets:
        annotations: 
          owner: enkryptai
          cost-center: ""
      image:
        repository: 188451452903.dkr.ecr.us-east-1.amazonaws.com/onprem/node-feature-discovery
        tag: v0.16.6
      master:
        resources:
          limits:
            cpu: 10m
            memory: 100Mi
          requests:
            cpu: 5m
            memory: 30Mi
        deploymentAnnotations: 
          owner: enkryptai
          cost-center: ""
      worker:
        resources:
          limits:
            cpu: 10m
            memory: 100Mi
          requests:
            cpu: 5m
            memory: 30Mi
        annotations: 
          owner: enkryptai
          cost-center: ""
      gc:
        resources:
          limits:
            cpu: 5m
            memory: 1G
          requests:
            cpu: 1m
            memory: 128Mi
        deploymentAnnotations: 
          owner: enkryptai
          cost-center: ""
    validator:
        repository: 188451452903.dkr.ecr.us-east-1.amazonaws.com
        image: onprem/gpu-operator-validator
        version: v24.9.0
        resources: 
          limits:
            cpu: 10m
            memory: 50Mi
          requests:
            cpu: 5m
            memory: 30Mi
    toolkit:
      repository: 188451452903.dkr.ecr.us-east-1.amazonaws.com
      image: onprem/container-toolkit
      version: v1.13.1-ubi8
      resources: 
        limits:
          cpu: 5m
          memory: 50Mi
        requests:
          cpu: 1m
          memory: 30Mi
    dcgm:
      repository: 188451452903.dkr.ecr.us-east-1.amazonaws.com
      image: onprem/dcgm-exporter
      version: 3.3.8-3.6.0-ubuntu22.04
    gfd:
      repository: 188451452903.dkr.ecr.us-east-1.amazonaws.com
      image: onprem/k8s-device-plugin
      version: v0.17.0-ubi9
      resources: 
        limits:
          cpu: 1m
          memory: 1Gi
        requests:
          cpu: 0.5m
          memory: 500Mi
    driver: 
      repository: 188451452903.dkr.ecr.us-east-1.amazonaws.com
      image: onprem/nvidia-driver
      version: 525.85.12-ubi9
      manager:
        repository: 188451452903.dkr.ecr.us-east-1.amazonaws.com
        image: onprem/k8s-driver-manager
        version: "v0.7.0"
    vgpuManager:
      repository: 188451452903.dkr.ecr.us-east-1.amazonaws.com
      image: onprem/vgpu-manager
      driverManager:
        repository: 188451452903.dkr.ecr.us-east-1.amazonaws.com
        image: onprem/k8s-driver-manager
        version: "v0.7.0"
    kataManager:
      repository: 188451452903.dkr.ecr.us-east-1.amazonaws.com
      image: onprem/k8s-kata-manager
      version: "v0.2.2"
    vfioManager:
      repository: 188451452903.dkr.ecr.us-east-1.amazonaws.com
      image: onprem/cuda
      version: "12.6.2-base-ubi9"

    vgpuDeviceManager:
      repository: 188451452903.dkr.ecr.us-east-1.amazonaws.com
      image: onprem/vgpu-device-manager
      version: "v0.2.8"
    ccManager:
      repository: 188451452903.dkr.ecr.us-east-1.amazonaws.com
      image: onprem/k8s-cc-manager
      version: "v0.1.1"
    devicePlugin:
      repository: 188451452903.dkr.ecr.us-east-1.amazonaws.com
      image: onprem/k8s-device-plugin
      resources: 
        limits:
          cpu: 1.5m
          memory: 1Gi
        requests:
          cpu: 1m
          memory: 500Mi   
      version: "v0.17.0-ubi9"
    dcgmExporter:
      repository: 188451452903.dkr.ecr.us-east-1.amazonaws.com
      image: onprem/dcgm-exporter
      version: "3.3.8-3.6.0-ubuntu22.04"
      resources: 
        limits:
          cpu: 1.5m
          memory: 1Gi
        requests:
          cpu: 1m
          memory: 500Mi
    migManager:
      repository: 188451452903.dkr.ecr.us-east-1.amazonaws.com
      image: onprem/k8s-mig-manager
      version: "v0.10.0-ubuntu20.04"
    nodeStatusExporter:
      repository: 188451452903.dkr.ecr.us-east-1.amazonaws.com
      image: onprem/gpu-operator-validator
      version: "v24.9.0"
    gdrcopy:
      repository: 188451452903.dkr.ecr.us-east-1.amazonaws.com
      image: onprem/gdrdrv
      version: "v2.4.1-2"
    sandboxDevicePlugin:
      repository: 188451452903.dkr.ecr.us-east-1.amazonaws.com
      image: onprem/kubevirt-gpu-device-plugin
      version: "v1.2.10"
  keydb:
    imageRepository: 188451452903.dkr.ecr.us-east-1.amazonaws.com/onprem/keydb
    imageTag: x86_64_v6.3.2
    resources: 
      limits:
        cpu: 30m
        memory: 1Gi
      requests:
        cpu: 10m
        memory: 500Mi
    annotations:
      owner: enkryptai
      cost-center: ""
  nats:
    natsBox:
      container:
        image:
          repository: onprem/nats-box
          tag: 0.18.0
      resources:
        limits:
          cpu: 1m
          memory: 10Mi
        requests:
          cpu: 0.5m 
          memory: 5Mi
    promExporter:
      image:
        repository: onprem/prometheus-nats-exporter
        tag: 0.17.3
    reloader:
      image:
        repository: onprem/nats-server-config-reloader
        tag: 0.19.1
    container:
      image:
        repository: onprem/nats
        tag: 2.11.8-alpine
      resources:
        limits:
          cpu: 1m
          memory: 10Mi
        requests:
          cpu: 0.5m 
          memory: 5Mi
    global: 
      image: 
        registry: 188451452903.dkr.ecr.us-east-1.amazonaws.com
  nack: 
    jetstream:
      enabled: true
      image:
        repository: onprem/jetstream-controller
        tag: 0.19.1
        registry: 188451452903.dkr.ecr.us-east-1.amazonaws.com
    podAnnotations: 
      owner: enkryptai 
      cost-center: ""

    nats: 
      url: nats://nats:4222
    resources:
        limits:
          cpu: 1m
          memory: 10Mi
        requests:
          cpu: 0.5m 
          memory: 5Mi
  argo-events: 
    namespaceOverride: "enkryptai-stack"
    configs:
      nats:
        versions:
          - version: latest
            natsStreamingImage: nats-streaming:latest
            metricsExporterImage: natsio/prometheus-nats-exporter:latest
          - version: 0.22.1
            natsStreamingImage: nats-streaming:0.22.1
            metricsExporterImage: natsio/prometheus-nats-exporter:0.8.0
      jetstream:
        settings:
          maxMemoryStore: -1
          maxFileStore: -1
        streamConfig:
          maxMsgs: 1000000
          maxAge: 72h
          maxBytes: 1GB
          replicas: 3
          duplicates: 300s
          retention: 0
          discard: 0
        versions:
          - version: latest
            natsImage: nats:2.10.10
            metricsExporterImage: natsio/prometheus-nats-exporter:0.14.0
            configReloaderImage: natsio/nats-server-config-reloader:0.14.0
            startCommand: /nats-server
          - version: 2.8.1
            natsImage: nats:2.8.1
            metricsExporterImage: natsio/prometheus-nats-exporter:0.9.1
            configReloaderImage: natsio/nats-server-config-reloader:0.7.0
            startCommand: /nats-server
          - version: 2.8.1-alpine
            natsImage: nats:2.8.1-alpine
            metricsExporterImage: natsio/prometheus-nats-exporter:0.9.1
            configReloaderImage: natsio/nats-server-config-reloader:0.7.0
            startCommand: nats-server
          - version: 2.8.2
            natsImage: nats:2.8.2
            metricsExporterImage: natsio/prometheus-nats-exporter:0.9.1
            configReloaderImage: natsio/nats-server-config-reloader:0.7.0
            startCommand: /nats-server
          - version: 2.8.2-alpine
            natsImage: nats:2.8.2-alpine
            metricsExporterImage: natsio/prometheus-nats-exporter:0.9.1
            configReloaderImage: natsio/nats-server-config-reloader:0.7.0
            startCommand: nats-server
          - version: 2.9.1
            natsImage: nats:2.9.1
            metricsExporterImage: natsio/prometheus-nats-exporter:0.9.1
            configReloaderImage: natsio/nats-server-config-reloader:0.7.0
            startCommand: /nats-server
          - version: 2.9.12
            natsImage: nats:2.9.12
            metricsExporterImage: natsio/prometheus-nats-exporter:0.9.1
            configReloaderImage: natsio/nats-server-config-reloader:0.7.0
            startCommand: /nats-server
          - version: 2.9.16
            natsImage: nats:2.9.16
            metricsExporterImage: natsio/prometheus-nats-exporter:0.9.1
            configReloaderImage: natsio/nats-server-config-reloader:0.7.0
            startCommand: /nats-server
          - version: 2.10.10
            natsImage: 188451452903.dkr.ecr.us-east-1.amazonaws.com/onprem/nats:2.10.10
            metricsExporterImage: 188451452903.dkr.ecr.us-east-1.amazonaws.com/onprem/prometheus-nats-exporter:0.14.0
            configReloaderImage: 188451452903.dkr.ecr.us-east-1.amazonaws.com/onprem/nats-server-config-reloader:0.14.0
            startCommand: /nats-server
    global:
      image:
        repository: 188451452903.dkr.ecr.us-east-1.amazonaws.com/onprem/argo-events
        tag: "v1.9.7"
        imagePullPolicy: IfNotPresent
    controller:
      resources:
        limits:
          cpu: 1.5m 
          memory: 100Mi
        requests:
          cpu: 1m
          memory: 50Mi
  argo-workflows:
    images:
      tag: ""
      pullPolicy: Always
      pullSecrets: []
    singleNamespace: false
    server:
      enabled: true
      baseHref: /
      image:
        registry: 188451452903.dkr.ecr.us-east-1.amazonaws.com
        repository: onprem/argocli
        tag: "v3.7.1"
      deploymentAnnotations: 
        cost-center: ""
        owner: enkryptai
      podAnnotations: {}
      podLabels: {}
      podSecurityContext: {}
      rbac:
        create: true
      securityContext:
        readOnlyRootFilesystem: false
        runAsNonRoot: true
        allowPrivilegeEscalation: false
        capabilities:
          drop:
            - ALL
      resources:
        limits:
          cpu: 1.5m 
          memory: 100Mi
        requests:
          cpu: 1m 
          memory: 50Mi
    executor:
      image:
        registry: 188451452903.dkr.ecr.us-east-1.amazonaws.com
        repository: onprem/argoexec
        tag: "v3.6.14"
        pullPolicy: ""
      resources: {}
      args: []
      env: []
      securityContext: {}
    controller:
      image:
        registry: 188451452903.dkr.ecr.us-east-1.amazonaws.com
        repository: onprem/workflow-controller
        tag: "v3.7.1"
      namespaceParallelism: "10"
      retentionPolicy:
        completed: 10
        failed: 3
        errored: 3
      resources:
        limits:
          cpu: 1.5m 
          memory: 100Mi
        requests:
          cpu: 1m 
          memory: 50Mi
      deploymentAnnotations: 
        cost-center: ""
        owner: enkryptai
externalSecret:
  enabled: false

commonAnnotations:
    owner: enkryptai
    cost-center: ""

openSearchAnnotations:
  owner: enkryptai
  cost-center: ""

# ------------------------------------------------
# OTEL CONFIG
# -----------------------------------------------
otel:
  enabled: false
  mode: daemonset
  annotations: 
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "20"
  ports:
    otlp:
      enabled: true
      containerPort: 4317
      hostPort: null

    otlp-http:
      enabled: true
      containerPort: 4318
      hostPort: null

    jaeger-compact:
      enabled: false

    jaeger-grpc:
      enabled: false

    jaeger-thrift:
      enabled: false

    zipkin:
      enabled: false
  image:
    repository: otel/opentelemetry-collector-contrib

  clusterRole:
    create: true
    rules:
    - apiGroups: [""]
      resources: ["pods", "namespaces", "nodes"]
      verbs: ["get", "list", "watch"]

    - apiGroups: ["apps"]
      resources: ["replicasets", "deployments", "statefulsets", "daemonsets"]
      verbs: ["get", "list", "watch"]

    - apiGroups: ["batch"]
      resources: ["jobs", "cronjobs"]
      verbs: ["get", "list", "watch"]

  tolerations:
  - key: "app"
    operator: "Equal"
    value: "redteaming"
    effect: "NoSchedule"
    
  resources:
    limits:
      cpu: 1000m
      memory: 1Gi
    requests:
      cpu: 200m
      memory: 512Mi
  
  extraEnvs:
    - name: NODE_NAME
      valueFrom:
        fieldRef:
          fieldPath: spec.nodeName
    - name: POD_IP
      valueFrom:
        fieldRef:
          fieldPath: status.podIP
    - name: OPENSEARCH_USERNAME
      valueFrom:
        secretKeyRef:
          name: opensearch-cred
          key: username
    - name: OPENSEARCH_PASSWORD
      valueFrom:
        secretKeyRef:
          name: opensearch-cred
          key: password
  
  config:
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318
      
      filelog:
        include: [/var/log/pods/*/*/*.log]
        exclude: [/var/log/pods/*/otel-*/*.log]
        start_at: beginning
        include_file_path: true
        operators:
          - type: container
            id: container-parser

    processors:

      batch:
        timeout: 10s
        send_batch_size: 256
        send_batch_max_size: 512
      
      memory_limiter:
        check_interval: 1s
        limit_mib: 800
      
      resource:
        attributes:
          - key: deployment.environment
            value: test
            action: insert
      
      resourcedetection:
        detectors: [env, system]
        timeout: 5s
      
      k8sattributes:
        auth_type: "serviceAccount"
        passthrough: false
        filter:
          node_from_env_var: NODE_NAME
        extract:
          metadata:
            - k8s.namespace.name
            - k8s.deployment.name
            - k8s.statefulset.name
            - k8s.daemonset.name
            - k8s.cronjob.name
            - k8s.job.name
            - k8s.node.name
            - k8s.pod.name
            - k8s.pod.uid
            - k8s.pod.start_time
            - k8s.pod.hostname
            - k8s.pod.ip
            - k8s.replicaset.uid
            - k8s.replicaset.name
            - k8s.deployment.uid
            - k8s.daemonset.uid
            - k8s.statefulset.uid
            - k8s.cronjob.uid
            - k8s.job.uid
            - k8s.cluster.uid
        pod_association:
          - sources:
              - from: resource_attribute
                name: k8s.pod.ip
          - sources:
              - from: connection
    extensions:
      health_check:
        endpoint: ${env:POD_IP}:13133
      basicauth/os:
        client_auth:
          username: ${env:OPENSEARCH_USERNAME}
          password: ${env:OPENSEARCH_PASSWORD}

    exporters:
      # debug:
      #   verbosity: basic
      
      opensearch:
        http:
          endpoint: https://enkryptai-opensearch-cluster:9200
          auth:
            authenticator: basicauth/os
          # tls:
          #   insecure_skip_verify: true
          tls:
            ca_file: /etc/opensearch/certs/ca.crt
          max_idle_conns: 100
          idle_conn_timeout: 90s
        
        logs_index: "otel-logs"
        traces_index: "otel-traces"

        sending_queue:
          enabled: true
          num_consumers: 5
          queue_size: 1000
        
        retry_on_failure:
          enabled: true
          initial_interval: 5s
          max_interval: 30s
          max_elapsed_time: 300s
        
        timeout: 60s

    service:
      extensions: [health_check, basicauth/os]
      pipelines:
        traces:
          receivers: [otlp]
          processors: [memory_limiter, resourcedetection, k8sattributes, resource, batch]
          exporters: [debug, opensearch]

        logs:
          receivers: [otlp, filelog]
          processors: [memory_limiter, resourcedetection, k8sattributes, resource, batch]
          exporters: [debug, opensearch]

  extraVolumes:
    - name: varlog
      hostPath:
        path: /var/log
    - name: opensearch-ca
      secret:
        secretName: enkryptai-opensearch-ca
        items:
          - key: ca.crt
            path: ca.crt

  extraVolumeMounts:
    - name: varlog
      mountPath: /var/log
      readOnly: true
    - name: opensearch-ca
      mountPath: /etc/opensearch/certs
      readOnly: true